<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mapillary Split View â€“ Coverage Tiles + Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Vector tiles for Leaflet -->
  <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

  <!-- MapillaryJS styles -->
  <link rel="stylesheet" href="https://unpkg.com/mapillary-js@latest/dist/mapillary.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    #wrap { height: 100vh; width: 100vw; display: grid; grid-template-columns: 50% 50%; }
    #mly, #map { height: 100%; width: 100%; }
    #toolbar {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,.95); padding: 8px 10px; border-radius: 8px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
    }
    #toolbar input { width: 360px; }
    .leaflet-popup-content { font: 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="mly"></div>
    <div id="map"></div>
  </div>

  <!-- Optional: token box (not required to click Apply; token is already active) -->
  <div id="toolbar">
    <div><strong>Mapillary token</strong></div>
    <input id="token" type="text" value="MLY|24462366120070331|7b445698e786aaa212354b607653e542" />
    <button id="apply">Apply</button>
  </div>

  <!-- Use ES module build of MapillaryJS -->
  <script type="module">
    import { Viewer } from "https://unpkg.com/mapillary-js@latest/dist/mapillary.module.js";

    // ====== CONFIG ======
    const INITIAL = { lat: 39.5, lng: -98.35, zoom: 4 };
    let ACCESS_TOKEN = "MLY|24462366120070331|7b445698e786aaa212354b607653e542"; // active by default
    // ====================

    // Initialize viewer
    let viewer = new Viewer({
      accessToken: ACCESS_TOKEN,
      container: 'mly',
      component: { cover: false }
    });

    // Initialize Leaflet map
    const map = L.map('map', { zoomControl: true, preferCanvas: true })
      .setView([INITIAL.lat, INITIAL.lng], INITIAL.zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Helper: format timestamp (ms since epoch)
    const fmtTime = (ms) => {
      const n = Number(ms);
      return Number.isFinite(n) ? new Date(n).toLocaleString() : String(ms);
    };

    // Styles
    const styles = {
      overview: (props, z) => ({
        radius: 3 + Math.max(0, z - 2),
        weight: 0,
        fill: true,
        fillColor: '#1e88e5',
        fillOpacity: 0.7
      }),
      sequence: (props, z) => ({
        weight: Math.min(6, Math.max(1, (z - 5) * 0.8)),
        color: props.is_pano ? '#8e24aa' : '#43a047',
        opacity: 0.8
      }),
      image: (props, z) => ({
        radius: 4 + Math.max(0, z - 14),
        weight: 1,
        color: '#0d47a1',
        fill: true,
        fillColor: props.is_pano ? '#ff6f00' : '#1976d2',
        fillOpacity: 0.9
      })
    };

    // Vector tile URL
    const tilesURL = () =>
      `https://tiles.mapillary.com/maps/vtp/mly1_public/2/{z}/{x}/{y}?access_token=${encodeURIComponent(ACCESS_TOKEN)}`;

    // SAFE: build a stable id from props only (no f.layer.name)
    const featureId = (f) => {
      const p = f && f.properties ? f.properties : {};
      // order: image id -> sequence id -> representative image -> fallback
      return String(p.id ?? p.sequence_id ?? p.image_id ?? Math.random());
    };

    // VectorGrid
    let vgrid = L.vectorGrid.protobuf(tilesURL(), {
      maxNativeZoom: 14,
      minZoom: 0,
      maxZoom: 19,
      interactive: true,
      vectorTileLayerStyles: {
        overview: (feat) => styles.overview(feat.properties, map.getZoom()),
        sequence: (feat) => styles.sequence(feat.properties, map.getZoom()),
        image:    (feat) => styles.image(feat.properties, map.getZoom())
      },
      getFeatureId: featureId
    }).addTo(map);

    function updateLayerVisibility() {
      const z = map.getZoom();
      vgrid.options.vectorTileLayerStyles.overview = (feat) => (z <= 5 ? styles.overview(feat.properties, z) : []);
      vgrid.optio
