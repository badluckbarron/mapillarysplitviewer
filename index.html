<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mapillary Split View – Coverage Tiles + Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <!-- Vector tiles for Leaflet -->
  <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js" defer></script>

  <!-- MapillaryJS (UMD) -->
  <link rel="stylesheet" href="https://unpkg.com/mapillary-js@latest/dist/mapillary.css" />
  <script src="https://unpkg.com/mapillary-js@latest/dist/mapillary.min.js" defer></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #wrap { height: 100vh; width: 100vw; display: grid; grid-template-columns: 50% 50%; }
    #mly, #map { height: 100%; width: 100%; }
    #toolbar {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,.95); padding: 8px 10px; border-radius: 8px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
    }
    #toolbar input { width: 360px; }
    .leaflet-popup-content { font: 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #err { position: absolute; top: 10px; right: 10px; z-index: 1100; color: #b00020; font: 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="mly"></div>
    <div id="map"></div>
  </div>

  <!-- Optional token box (your token is already active; this is just for swapping) -->
  <div id="toolbar">
    <div><strong>Mapillary token</strong></div>
    <input id="token" type="text" value="MLY|24462366120070331|7b445698e786aaa212354b607653e542" />
    <button id="apply">Apply</button>
  </div>

  <div id="err"></div>

  <script defer>
    window.addEventListener('load', () => {
      const err = (msg) => { const el = document.getElementById('err'); el.textContent = msg || ''; };

      // Make sure libs are present
      if (!window.L) { err('Leaflet failed to load.'); return; }
      if (!window.leafletVectorGrid && !L.vectorGrid) { err('Leaflet.VectorGrid failed to load.'); return; }
      if (!window.mapillary || !window.mapillary.Viewer) { err('MapillaryJS failed to load.'); return; }

      // ====== CONFIG ======
      const INITIAL = { lat: 30.138307, lng: -91.965153, zoom: 12 }; // Lafayette area (you can change)
      let ACCESS_TOKEN = "MLY|24462366120070331|7b445698e786aaa212354b607653e542"; // active immediately
      // ====================

      err(''); // clear any message

      // Initialize viewer (global UMD: mapillary.Viewer)
      let viewer = new mapillary.Viewer({
        accessToken: ACCESS_TOKEN,
        container: 'mly',
        component: { cover: false }
      });

      // Initialize Leaflet map
      const map = L.map('map', { zoomControl: true, preferCanvas: true })
        .setView([INITIAL.lat, INITIAL.lng], INITIAL.zoom);

      // Basemap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Helper: format timestamp (ms since epoch)
      const fmtTime = (ms) => {
        const n = Number(ms);
        return Number.isFinite(n) ? new Date(n).toLocaleString() : String(ms);
      };

      // Styles
      const styles = {
        overview: (props, z) => ({
          radius: 3 + Math.max(0, z - 2),
          weight: 0,
          fill: true,
          fillColor: '#1e88e5',
          fillOpacity: 0.7
        }),
        sequence: (props, z) => ({
          weight: Math.min(6, Math.max(1, (z - 5) * 0.8)),
          color: props.is_pano ? '#8e24aa' : '#43a047',
          opacity: 0.8
        }),
        image: (props, z) => ({
          radius: 4 + Math.max(0, z - 14),
          weight: 1,
          color: '#0d47a1',
          fill: true,
          fillColor: props.is_pano ? '#ff6f00' : '#1976d2',
          fillOpacity: 0.9
        })
      };

      // Vector tile URL
      const tilesURL = () =>
        `https://tiles.mapillary.com/maps/vtp/mly1_public/2/{z}/{x}/{y}?access_token=${encodeURIComponent(ACCESS_TOKEN)}`;

      // SAFE feature id (no f.layer.name use)
      const featureId = (f) => {
        const p = f && f.properties ? f.properties : {};
        return String(p.id ?? p.sequence_id ?? p.image_id ?? Math.random());
      };

      // VectorGrid
      let vgrid = L.vectorGrid.protobuf(tilesURL(), {
        maxNativeZoom: 14,
        minZoom: 0,
        maxZoom: 19,
        interactive: true,
        vectorTileLayerStyles: {
          overview: (feat) => styles.overview(feat.properties, map.getZoom()),
          sequence: (feat) => styles.sequence(feat.properties, map.getZoom()),
          image:    (feat) => styles.image(feat.properties, map.getZoom())
        },
        getFeatureId: featureId
      }).addTo(map);

      function updateLayerVisibility() {
        const z = map.getZoom();
        vgrid.options.vectorTileLayerStyles.overview = (feat) => (z <= 5 ? styles.overview(feat.properties, z) : []);
        vgrid.options.vectorTileLayerStyles.sequence = (feat) => (z >= 6 && z <= 14 ? styles.sequence(feat.properties, z) : []);
        vgrid.options.vectorTileLayerStyles.image    = (feat) => (z >= 14 ? styles.image(feat.properties, z) : []);
        vgrid.redraw();
      }
      map.on('zoomend', updateLayerVisibility);
      updateLayerVisibility();

      // Click -> load image in viewer
      vgrid.on('click', (e) => {
        const props = e.layer && e.layer.properties ? e.layer.properties : {};
        const z = map.getZoom();
        const layerGuess = (z <= 5 ? 'overview' : (z >= 14 ? 'image' : 'sequence'));

        if (layerGuess === 'image' && props.id) {
          viewer.moveTo(String(props.id));
          L.popup().setLatLng(e.latlng).setContent(
            `<b>Image</b><br/>id: ${props.id}<br/>captured_at: ${fmtTime(props.captured_at)}<br/>creator_id: ${props.creator_id}`
          ).openOn(map);
        } else if (layerGuess === 'sequence') {
          const repImage = props.image_id;
          const seqId = props.id || props.sequence_id;
          if (repImage) viewer.moveTo(String(repImage));
          L.popup().setLatLng(e.latlng).setContent(
            `<b>Sequence</b><br/>id: ${seqId}<br/>image_id: ${repImage ?? '—'}<br/>captured_at: ${fmtTime(props.captured_at)}<br/>creator_id: ${props.creator_id}`
          ).openOn(map);
        } else {
          L.popup().setLatLng(e.latlng).setContent(
            `<b>Coverage overview</b><br/>image id: ${props.id}<br/>captured_at: ${fmtTime(props.captured_at)}`
          ).openOn(map);
        }
      });

      // Optional: token swap (not required)
      document.getElementById('apply').addEventListener('click', () => {
        const t = document.getElementById('token').value.trim();
        if (!t) return;
        ACCESS_TOKEN = t;

        map.removeLayer(vgrid);
        vgrid = L.vectorGrid.protobuf(tilesURL(), {
          maxNativeZoom: 14,
          minZoom: 0,
          maxZoom: 19,
          interactive: true,
          vectorTileLayerStyles: vgrid.options.vectorTileLayerStyles,
          getFeatureId: featureId
        }).addTo(map);
        updateLayerVisibility();

        const mly = document.getElementById('mly');
        mly.innerHTML = '';
        viewer = new mapillary.Viewer({
          accessToken: ACCESS_TOKEN,
          container: 'mly',
          component: { cover: false }
        });
      });
    });
  </script>
</body>
</html>
